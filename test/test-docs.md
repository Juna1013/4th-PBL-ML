# テスト用ライントレースプログラム

8個のフォトリフレクタを使った重み付けベースのライントレース最小実装

## ファイル構成

- `main.py` - メインプログラム（設定値を含む統合版、これだけで動作）
- `test-docs.md` - このドキュメント

## ハードウェア接続

### モーター（MakerDrive）

- GPIO 5 (M1A): 左モーター前進
- GPIO 4 (M1B): 左モーター後退
- GPIO 3 (M2A): 右モーター前進
- GPIO 2 (M2B): 右モーター後退

### フォトリフレクタ（8個、左から右へ）

```bash
GPIO: 16  17  18  19  20  21  22  28
重み: -7  -5  -3  -1  +1  +3  +5  +7
位置: [左端 ←――――――――――――――→ 右端]
```

## 使い方

1. Pico Wに`main.py`をアップロード
2. センサーとモーターを接続
3. BOOTSELボタンを押してスタート
4. もう一度BOOTSELボタンを押すか、Ctrl+Cで停止

## アルゴリズム

### 重み付け計算

1. 各センサーが黒（ライン）を検出したら、そのセンサーの重みを加算
2. 検出したセンサー数で割って平均位置を算出
3. 結果: -7（最左）～ +7（最右）

### PD制御

```bash
correction = Kp × error + Kd × (error - last_error)
左モーター速度 = BASE_SPEED - correction
右モーター速度 = BASE_SPEED + correction
```

- error が正（ラインは右側）→ 左モーター減速、右モーター加速 → 右旋回
- error が負（ラインは左側）→ 右モーター減速、左モーター加速 → 左旋回

## パラメータ調整

`main.py`の設定セクション（9-35行目）で調整可能：

- `BASE_SPEED`: 基本速度（速すぎる/遅すぎる場合）
- `KP`: 比例ゲイン（反応速度）
- `KD`: 微分ゲイン（安定性）

### 現在の設定値

```python
BASE_SPEED = 30000  # 基本速度（0-65535）
MAX_SPEED = 54613   # 最大速度
KP = 50  # 比例ゲイン
KD = 10  # 微分ゲイン
```

## デバッグ表示

実行中に20ループごとに以下を表示：

```bash
■■□□□□□□ | -5.0 | ON
```

- `■`: 黒検出（ライン上）
- `□`: 白検出（背景）
- 数値: ライン位置（-7～+7）
- `ON/LOST`: ライン検出状態

## トラブルシューティング

### 直進しない

- センサーの位置を確認
- 重みの符号を確認（左が負、右が正）
- BASE_SPEEDを調整

### 蛇行が激しい

- KPを小さく（例: 30）→ `main.py`の30行目を編集
- KDを大きく（例: 20）→ `main.py`の32行目を編集

### ラインを見失う

- BASE_SPEEDを下げる（例: 20000）→ `main.py`の25行目を編集
- センサーの高さを調整

### カーブで曲がれない

- KPを大きく（例: 70）→ `main.py`の30行目を編集
- MAX_SPEEDを確認（`main.py`の26行目）
