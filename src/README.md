# ライントレース + WiFi通信プログラム

Raspberry Pi Pico W用のライントレース制御プログラム（WiFi通信機能付き）

## 📁 ファイル構成

```
src/
├── main.py       # メインプログラム（ライントレース + WiFi通信）
├── config.py     # WiFi設定とAPI URL
└── README.md     # このファイル
```

## 🚀 概要

このプログラムは、8チャンネル光学センサーを使用したPD制御ライントレースカーのファームウェアです。
WiFi経由でリアルタイムにテレメトリデータを送信し、Webダッシュボードで状態を監視できます。

## ✨ 主な機能

- **PD制御ライントレース**: 比例・微分制御による滑らかなライン追従
- **WiFi通信**: Vercelにデプロイされたサーバーへのリアルタイムデータ送信
- **モーター補正**: 左右のモーター出力差を自動補正
- **減速制御**: カーブで自動的に速度を落として安定走行
- **エラーハンドリング**: WiFi接続失敗時でもライントレースは継続

## ⚙️ ハードウェア構成

### ピン配置

| 機能 | ピン番号 |
|------|---------|
| センサー 1-8 | 22, 21, 28, 27, 26, 18, 17, 16 |
| 左モーター FWD | GP5 |
| 左モーター REV | GP4 |
| 右モーター FWD | GP2 |
| 右モーター REV | GP3 |
| LED | オンボードLED |

### 制御パラメータ

```python
BASE_SPEED = 8000              # 基本速度（PWM値: 0-65535）
LEFT_MOTOR_CORRECTION = 0.77   # 左モーター補正係数
RIGHT_MOTOR_CORRECTION = 1.0   # 右モーター補正係数
KP = 9000                      # 比例ゲイン
KD = 3000                      # 微分ゲイン
WEIGHTS = [-7, -5, -3, -1, 1, 3, 5, 7]  # センサー重み付け
```

## 📡 WiFi通信

### 設定方法

`config.py`を編集して、WiFi認証情報とAPI URLを設定します：

```python
# WiFi設定
SSID = "あなたのWiFi SSID"
PASSWORD = "あなたのパスワード"

# サーバー設定
API_URL = "https://endra-hub.vercel.app/api/telemetry"
```

### 送信データフォーマット

500msごとに以下のJSON形式でデータを送信します：

```json
{
  "timestamp": 12345678,
  "sensors": [0, 0, 1, 1, 1, 1, 0, 0],
  "motor": {
    "left_speed": 6160,
    "right_speed": 8000
  },
  "control": {
    "error": -2.5,
    "turn": 5000,
    "base_speed": 8000
  },
  "wifi": {
    "ip": "192.168.1.100",
    "rssi": -45
  }
}
```

## 🔧 書き込み方法

### 必要なファイル

マイコンのルートディレクトリに以下の2ファイルを配置：

1. `main.py` - メインプログラム
2. `config.py` - WiFi設定ファイル

### 手順

1. Raspberry Pi Pico WをUSBで接続
2. Thonny等のエディタで`config.py`を編集
3. `main.py`と`config.py`をマイコンに転送
4. マイコンをリセット（自動起動）

## 🎯 動作フロー

```
起動
 │
 ├─ ハードウェア初期化
 │   ├─ モーター初期化
 │   ├─ センサー初期化
 │   └─ LED初期化
 │
 ├─ WiFi接続試行（最大5秒）
 │   ├─ 成功 → テレメトリ送信有効
 │   └─ 失敗 → ライントレースのみ実行
 │
 └─ メインループ
     ├─ センサー読み取り
     ├─ 誤差計算（重み付け平均）
     ├─ PD制御（turn値計算）
     ├─ 速度計算（減速制御適用）
     ├─ モーター出力
     └─ テレメトリ送信（500ms毎）
```

## 🐛 トラブルシューティング

### WiFi接続できない

- `config.py`のSSID/パスワードが正しいか確認
- WiFiルーターの電源が入っているか確認
- 2.4GHz帯のWiFiを使用していることを確認（5GHz非対応）

### モーターが動かない

- 電源供給が十分か確認
- モーター配線が正しいか確認
- シリアル出力で`L:xxxx R:xxxx`の値を確認

### センサーが反応しない

- センサー配線を確認
- シリアル出力で「センサー状態: ...」を確認
- センサーの感度調整が必要な場合あり

### データが送信されない

- WiFi接続が成功しているか確認
- `config.API_URL`が正しいか確認
- シリアル出力で「📤 送信成功」または「⚠️ 送信失敗」を確認

## 📊 シリアル出力例

正常動作時の出力：

```
==================================================
WiFi接続開始
==================================================
接続中: iPhone SG
..........
✅ WiFi接続成功!
   IPアドレス: 192.168.1.100
   サーバー: https://endra-hub.vercel.app/api/telemetry
==================================================
=== ライントレース開始（改良版） ===
   (Ctrl+C で停止)
==================================================
センサー状態: 1 1 0 0 1 1 1 1
🔄 送信試行中... (WiFi接続: OK)
📤 送信成功 [1] | L:6160 R:8000 | エラー:-2.00
センサー状態: 1 1 1 0 0 1 1 1
🔄 送信試行中... (WiFi接続: OK)
📤 送信成功 [2] | L:8000 R:6160 | エラー:2.00
```

## 🔗 関連リンク

- **Webダッシュボード**: https://endra-hub.vercel.app/dashboard
- **テストプログラム**: `../test/integration_test/test_01.py`（WiFi通信なし版）

## 📝 ライセンス

このプロジェクトは教育目的で作成されています。
