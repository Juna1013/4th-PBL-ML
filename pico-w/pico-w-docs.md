# Pico W ライントレースカー制御プログラム

## 概要

Raspberry Pi Pico W を使用したライントレースカーの制御プログラムです。
WiFi経由でサーバーと通信し、音声認識コマンドに基づいてモーターを制御するほか、
8個のフォトリフレクタセンサーを使った高精度なライントレース機能を搭載しています。

## ファイル構成

### main.py（統合済み）

**すべての機能が統合されたメインプログラムです。**

以下のクラスと機能を含みます：

#### 設定部分

- WiFi設定、サーバーURL、ハードウェアピン設定
- ライントレース制御パラメータ（PID制御、センサー重み付け）

#### 主要クラス

- **`PicoWController`**: メインシステム制御
- **`WiFiClient`**: WiFi通信とサーバー制御
- **`MotorController`**: モーター制御（通常制御 + ライントレース制御）
- **`PhotoReflector`**: 8個のフォトリフレクタセンサー制御
- **`LineTraceController`**: ライントレース専用制御
- **`AudioCapture`**: 音声キャプチャ（基本実装）

#### 実行モード

- **通常モード**: WiFi + サーバー制御
- **スタンドアロンモード**: WiFi不要のライントレース

### backup/（旧ファイル）

統合前の個別ファイルがバックアップとして保存されています。

## セットアップ手順

### 1. ハードウェア接続

#### モーター制御（MakerDrive互換）

- **M1A（左モーター前進）**: GP5
- **M1B（左モーター後退）**: GP4  
- **M2A（右モーター前進）**: GP3
- **M2B（右モーター後退）**: GP2

#### 8個フォトリフレクタセンサー（ライントレース用）

左から右へ順番に配置：

- **センサー0**: GP16 (重み: -7)
- **センサー1**: GP17 (重み: -5)
- **センサー2**: GP18 (重み: -3)
- **センサー3**: GP19 (重み: -1)
- **センサー4**: GP20 (重み: +1)
- **センサー5**: GP21 (重み: +3)
- **センサー6**: GP22 (重み: +5)
- **センサー7**: GP28 (重み: +7)

#### その他

- **音声入力**: GP26 (ADC0)

### 2. 設定の編集

main.py 内の設定部分を編集：

```python
# WiFi設定
WIFI_SSID = "あなたのWiFi名"
WIFI_PASSWORD = "あなたのWiFiパスワード"

# サーバー設定
SERVER_URL = "https://your-api-server.render.com/api"
# または開発時: "http://192.168.1.100:8000/api"
```

### 3. プログラムの書き込みと実行

1. **main.py** を Pico W に転送
2. Pico W を再起動してプログラム実行

#### 実行方法

**通常モード（WiFi + サーバー制御）:**

```bash
python main.py
```

**スタンドアロンモード（WiFi不要ライントレース）:**

```bash
python main.py standalone
```

## 動作仕様

### 通常モード（WiFi制御）

#### 対応コマンド

- **`FORWARD`**: 前進
- **`BACK`**: 後退  
- **`LEFT`**: 左旋回（その場旋回）
- **`RIGHT`**: 右旋回（その場旋回）
- **`STOP`**: 停止
- **`LINE_TRACE`**: ライントレースモード開始

#### 通信プロトコル

- コマンド取得: `GET /api/command/latest`
- ステータス送信: `POST /api/pico/status`

#### 動作ループ

1. WiFi接続確立
2. サーバーから最新コマンド取得
3. コマンド変更時のみモーター制御実行
4. ステータスをサーバーに送信
5. 設定された間隔（1秒）で待機
6. 2に戻る

### スタンドアロンモード（ライントレース）

#### ライントレース仕様

- **センサー**: 8個のデジタルフォトリフレクタ
- **制御方式**: 重み付け平均 + PD制御
- **アルゴリズム**: 
  1. 各センサーに重み（-7〜+7）を割り当て
  2. 黒線を検出したセンサーの重み付け平均でライン位置を算出
  3. PD制御で左右モーターの速度を調整

#### 制御パラメータ

```python
BASE_SPEED = 30000      # 基本速度
MAX_SPEED = 54613       # 最大速度
KP = 50                 # 比例ゲイン
KD = 10                 # 微分ゲイン
SENSOR_WEIGHTS = [-7, -5, -3, -1, 1, 3, 5, 7]  # センサー重み
```

#### 操作方法

- **開始**: BOOTSELボタンを押す（BOOTSELが利用できない場合は3秒後に自動開始）
- **停止**: BOOTSELボタンを押す、またはCtrl+C

### 必要なライブラリ

Pico W に以下のライブラリが必要：

- `machine`, `network`, `urequests`, `ujson`
- `time`, `gc`, `array`
- `rp2` (BOOTSELボタン制御用、オプション)

## トラブルシューティング

### WiFi接続失敗

- SSID/パスワードの確認
- WiFiルーターの電波強度確認
- main.py 内の WiFi設定確認

### サーバー通信エラー

- サーバーURLの確認
- ネットワーク接続状況確認
- ファイアウォール設定確認

### モーター動作不良

- ハードウェア接続確認（GP2-5ピン）
- 電源供給確認
- MakerDrive接続確認

### ライントレース不調

- **センサー接続確認**: GP16-22, 28の接続
- **ライン検出確認**: デバッグ情報で確認

  ```
  ■□□■■■□□ | Pos: +1.25 | ON
  ```

  - ■: ライン検出（黒）
  - □: ライン外（白）
  - Pos: ライン位置（-7〜+7）
  - ON/LOST: ライン検出状態

- **PID調整**: KP（比例ゲイン）、KD（微分ゲイン）の調整
- **速度調整**: BASE_SPEED, MAX_SPEEDの調整

## 開発・デバッグ

### シリアル出力の確認

プログラム実行中のログは Thonny や PuTTY などでシリアル接続して確認可能。

### デバッグ情報

- **ライントレース**: 10ループごとにセンサー状態とライン位置を表示
- **WiFi通信**: コマンド取得・送信状況を表示
- **エラー**: 例外発生時の詳細情報を表示

### エラーハンドリング

各処理でエラーが発生した場合、自動的に安全停止状態に移行します。

## カスタマイズ

### ライントレース調整

main.py内の以下パラメータで調整可能：

```python
# 速度調整
BASE_LINE_SPEED = 30000     # より速く: 値を大きく
MAX_LINE_SPEED = 54613      # 最大速度制限

# PID制御調整  
KP = 50    # 反応の強さ（大きいほど敏感）
KD = 10    # 安定性（大きいほど振動抑制）

# センサー感度
SENSOR_WEIGHTS = [-7, -5, -3, -1, 1, 3, 5, 7]  # 重み調整
```

### 新しいコマンド追加

`PicoWController.handle_command()` メソッドに新しいコマンドを追加可能：

```python
def handle_command(self, command):
    if command == "NEW_COMMAND":
        # 新しい動作を実装
        pass
```

## 統合されたファイル構成

### 統合前（backup/）

- `config.py`: 設定
- `wifi_client.py`: WiFi通信
- `motor_control.py`: モーター制御
- `sensors.py`: センサー制御
- `line_trace_controller.py`: ライントレース制御
- `line_trace_standalone.py`: スタンドアロン版
- `audio_capture.py`: 音声キャプチャ

### 統合後

- **`main.py`**: 全機能統合（655行）
  - 管理の簡素化
  - インポート依存関係の解消
  - デプロイの簡易化
